<html>
    <head>
        <title>gCalBirthdays</title>

        <script type="text/javascript" src="http://www.google.com/jsapi"></script>
		
        <script type="text/javascript">

            /* Copyright (c) 2009 Frank Glaser
             * TODO 
             */
			
            // http://code.google.com/p/gcalbirthdays/source/browse/trunk/gCalBirthdays/test/gCalBirthdays.html
            // http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/test/gCalBirthdays.html
            
            /* Copyright (c) 2007 Google Inc.
             *
             */
            //load the Google data JS Client Library
            google.load('gdata', '1.x');
            //google.load("gdata", "1.x", {packages: ["contacts", "calendar"]});
//			google.load("jquery", "1.3.2");
//		  	google.load("jqueryui", "1.7.2");
//			google.load("prototype", "1.6.0.3");
//		  	google.load("scriptaculous", "1.8.2");
//		  	google.load("mootools", "1.2.3");
//		  	google.load("dojo", "1.3.1");
//		  	google.load("swfobject", "2.2");
//		  	google.load("yui", "2.7.0");
//		  	google.load("ext-core", "3.0.0");
                        
            var APP_NAME = 'gCalBirthdays';
            
            var CALENDAR_NAME = 'Birthdays'; //"Geburtstage";
            var CALENDAR_SUMMARY = 'This calendar contains the birthdays of Your Google Contacts.';
            var CALENDAR_COLOR = '#A32929'; // red "#A32929", blue "#2952A3" and green "#0D7813"
            var GOOGLE_FEED_AUTH = 'http://www.google.com/m8/feeds/ http://www.google.com/calendar/feeds/';
            var CONTACTS_FEED_URL = 'http://www.google.com/m8/feeds/contacts/default/full?v=3.0';
			//var CONTACTS_FEED_URL = 'http://www.google.com/m8/feeds/contacts/default/full';
			//var CONTACTS_FEED_URL = 'http://www.google.com/m8/feeds/contacts/default/full?max-results=1';
            var CALENDAR_FEED_URL = 'http://www.google.com/calendar/feeds/default/owncalendars/full';
			//var CALENDAR_FEED_URL = 'http://www.google.com/calendar/feeds/default/allcalendars/full';
            
            var DATE_FORMAT_CONTACTS = 'yyyy-MM-dd';
            var DATE_FORMAT_CALENDAR = 'yyyyMMdd';
            var DATE_FORMAT_YEAR = 'yyyy';
            
            var REMINDER_DAYS = 14;
            
            var MAX_RESULT = 10;
            
            var conService;
            var calService;

			var batchURL;
			var eventURL;
			      
			var token;
			
			contactList = new Array();		
			eventList = new Array();
					     
            /**
             * This function checks if the user is logged in,
             * and changes the login button and displayed sections accordingly.
             * It also initializes the calendarService variable
             * and calls a function to fill in the form based on the URL.
             */
            function init(){
                var authButton = document.getElementById('auth_button');
				
				conService = new google.gdata.client.GoogleService('cp', 'APP_NAME');   
				//conService = new google.gdata.contacts.ContactsService(APP_NAME);
                calService = new google.gdata.calendar.CalendarService(APP_NAME); 
				
                token = google.accounts.user.checkLogin(GOOGLE_FEED_AUTH);
                if (token) {
                    // User is loged in
                    authButton.value = 'Logout';
					document.getElementById('htmlTable').style.display = 'block';
					main();
                }
				else {
					// User is loged out
					authButton.value = 'Login';
					document.getElementById('loginNotice').style.display = 'block';

					var htmlTableHeader = document.getElementById('htmlTableHeaderID');
					htmlTableHeader.innerHTML = '';
					var htmlTableContent = document.getElementById('htmlTableContentID');
                	htmlTableContent.innerHTML = '';
                }
            };
            
            //Tells the google JS lib to call the init function once loaded
            google.setOnLoadCallback(init);
            
            /**
             * This function is triggered by the login/logout button.
             * If the user is logged in to the app, it logs them out.
             * If the user is logged out to the app, it logs them in.
             */
            function loginOrLogout(){
                token = google.accounts.user.checkLogin(GOOGLE_FEED_AUTH);
                if (token) {
					// User is loged in
                    google.accounts.user.logout();
                }
                else {
					// User is loged out
                    token = google.accounts.user.login(GOOGLE_FEED_AUTH);
                }
				init();				
            }
			
			function main(){  		
				getContacts( CONTACTS_FEED_URL );
				
                //getCalendars( CALENDAR_FEED_URL ); // is executed by getContacts()
				//getEvents( eventURL );  			 // is executed by getCalendars()
			}
			
			function getContacts(conURL){ 
				//var conQuery = new google.gdata.contacts.ContactQuery(CONTACTS_FEED_URL);
				//conQuery.setSortOrder('ascending');
  				//conService.getContactFeed(conQuery, handleContactsFeed, handleError);
				
				// ContactsService v2
				//conService.getContactFeed(conURL, handleContactsFeed, handleError);
				
				// WorkAround
				conService.getFeed(conURL, handleContactsFeed, handleError);	
			}

            function handleContactsFeed(conFeedRoot){
				conFeed = conFeedRoot.feed;
				
				// ContactsService v2
				//contacts = conFeed.getEntries();
                //for (var i = 0; i < contacts.length; i++) {
                //	contactList.push(contacts[i]);
                //}
				
				// WorkAround
				//for (var i = 0; i < conFeed.entry.length; ++i) {
				//	contactList.push(conFeed.entry[i]);
				//}
			   //for (var i = 0; i < conFeed.entry.length; ++i) {
			   for each ( var contact in conFeed.entry ) {
			      // Push only if contact has a title or fullname ???????
			      if ( contact.title.$t ) {
			         // Push only if contact has a birthday
			         if ( contact.gContact$birthday ) {
			            contactList.push( contact );      
			         }
			      }
			   }

				// ContactsService v2
//				var nextLink = conFeed.getNextLink();
//		        if ( nextLink ) {
//					var nextURL = conFeed.getNextLink().href;
//					//getContacts( nextURL );	
//				}
//				else {
//					displayContacts();
//					getCalendars( CALENDAR_FEED_URL );
//				}

				// WorkAround
				for each ( var link in conFeed.link ) {
					if ('next' == link.rel) {
						return getContacts (link.href);				
					}
				}
				displayContacts();
				getCalendars( CALENDAR_FEED_URL );
            }
            
			function displayContacts() {
				var htmlTableContent = document.getElementById('htmlTableContentID');
                var table = document.createElement('table');
                var tbody = document.createElement('tbody');
                
				for each ( var contact in contactList ) {
				//for (var i = 0; i < contactList.length; i++) {
					
					// ContactsService v2
                    //var conTitle = contactList[i].getTitle().getText();;
                    
					// WorkAround
					var conTitle = contact.title.$t;
					if (contact.gContact$birthday) { 
						conTitle = conTitle + ' ' + contact.gContact$birthday.when;
					}
					
                    var row = document.createElement('tr');
                    var cell = document.createElement('td');
                    cell.appendChild(document.createTextNode("contact: "+conTitle));
                    row.appendChild(cell);
                    tbody.appendChild(row);
                }
				table.appendChild(tbody);
                htmlTableContent.appendChild(table);
			}
			    
            function getCalendars(calURL){
				calService.getOwnCalendarsFeed(calURL, handleCalendarsFeed, handleError);
            }
            
            function handleCalendarsFeed(calFeedRoot){
				calFeed = calFeedRoot.feed;
                calendars = calFeed.getEntries();

				var calEntry;                
				for each ( var calendar in calendars ) {
                //for (var i = 0; i < calendars.length; i++) {
                    var calTitle = calendar.getTitle().getText();
                    if (-1 != calTitle.search(CALENDAR_NAME)) {
                        // Found CalendarEntry
 						calEntry = calendar;
						//alert ('found calendar');
                    }
                }
							
				if ( null == calEntry ) {
					// Create calendar
					createCalendar();	
					
					// Get Calendars again
					getCalendars( CALENDAR_FEED_URL );
                }
				else {
					// Get Calendar URL
					eventURL = calEntry.getLink().href;
					getEvents( calEntry.getLink().href );	
				}
            }

            function createCalendar(){
				// Create calendar only once
				// Check to see if the counter has been initialized
    			if ( 'undefined' == typeof createCalendar.counter ) {
        			// It has not... perform the initilization
        			createCalendar.counter = 1;
					
					// Create an instance of CalendarEntry, representing the new calendar
	                var calEntry = new google.gdata.calendar.CalendarEntry();
	                
	                // Set the calendar title
	                calEntry.setTitle(google.gdata.Text.create(CALENDAR_NAME));
	                
	                // Set the calendar summary
	                var summary = new google.gdata.Text();
	                summary.setText(CALENDAR_SUMMARY);
	                calEntry.setSummary(summary);
	                
	                // Set the calendar timezone
	                //var timeZone = new google.gdata.calendar.TimeZoneProperty();
	                //timeZone.setValue('America/Los_Angeles');
	                //calEntry.setTimeZone(timeZone);
	                
	                // Set the calendar location
	                //var where = new google.gdata.Where();
	                //where.setLabel('Mountain View, CA');
	                //where.setValueString('Mountain View, CA');
	                //calEntry.addLocation(where);
	                
					// Set the color that represent this calendar in the Google Calendar UI
	                var color = new google.gdata.calendar.ColorProperty();
	                color.setValue(CALENDAR_COLOR);
	                calEntry.setColor(color);
	                
	                // Set the calendar to be visible in the Google Calendar UI
	                var hidden = new google.gdata.calendar.HiddenProperty();
	                hidden.setValue(false);
	                calEntry.setHidden(hidden);
	                
					// Set the calendar to be selected in the Google Calendar UI
	                var selected = new google.gdata.calendar.SelectedProperty();
	                selected.setValue(true);
	                calEntry.setSelected(selected);
	                
	                // The callback method that will be called after a successful
	                // insertion from insertEntry()
	                var calCallback = function(result){
	                    alert('birthday calendar created!');
	                }
	                
	                // Submit the request using the calendar service object
	                calService.insertEntry(CALENDAR_FEED_URL, calEntry, calCallback, handleError, google.gdata.calendar.CalendarEntry);
    			}
			}           

            function getEvents( eventURL ) {
			  calService.getEventsFeed(eventURL, handleEventsFeed, handleError);
            }
            
			function handleEventsFeed(eventFeedRoot) {
                eventFeed = eventFeedRoot.feed;
                events = eventFeed.getEntries();
                
				batchURL = eventFeed.getFeedBatchLink().href;
				
				for each ( var event in events ) {
                //for (var i = 0; i < events.length; i++) {
                    eventList.push(event);
				}
                
				var nextLink = eventFeed.getNextLink();
		        if ( nextLink ) {
					var nextURL = eventFeed.getNextLink().href;
					getEvents( nextURL );	
				}	
				else {
					displayEvents();
					//checkEvents();
				}			
            }

			function displayEvents() {
				var htmlTableContent = document.getElementById('htmlTableContentID');
                var table = document.createElement('table');
                var tbody = document.createElement('tbody');
                
				for each ( var event in eventList ) {
				//for (var i = 0; i < eventList.length; i++) {
                    var eventTitle = event.getTitle().getText();;
                    
                    var row = document.createElement('tr');
                    var cell = document.createElement('td');
                    cell.appendChild(document.createTextNode("event: "+eventTitle));
                    row.appendChild(cell);
                    tbody.appendChild(row);
                }
				table.appendChild(tbody);
                htmlTableContent.appendChild(table);
			}
				
function checkEvents() {
   var entry;
   var exists = false;
   var update = false;
   var batchid = 0;

    for each ( var contact in conList ) {
      var date = contact.gContact$birthday.replace(/-/g,'');
      if ( 8 != date.length() ) {
         date = '1970'+date; //to comply with Java date http://java.sun.com/j2se/1.3/docs/api/
      } 
      //for (var e = 0; e < eventList.length; e++) {
      //for each (var tier in tiere)
      for each ( var event in eventList ) {
        exists = false;
        update = false;
        
        // Check contact title or fullname ???????
        if ( -1 != event.getTitle().getPlainText().search( contact.title.$t ) ) {
        //if (-1 != event.getTitle().getPlainText().indexOf(contact.title.$t)) {
        //str.search(/W3Schools/i); // Case-insensitive Search
            // Event found for given contact
            // Check date
            //var date = contact.gContact$birthday;
            //if ( -1 != event.getRecurrence().getValue().search( date.replace(/-/g,'') ) ) {
            if ( -1 != event.getRecurrence().getValue().search( date ) ) {
                 // Date correct - nothing todo
                 exists = true;
            }
            else {
                 // Date not correct - update date
                 exists = false;
                 update = true;
                 entry = event;
            }
         }
         else {
            // Event not found for given contact
            exists = false;
            entry = new google.gdata.calendar.CalendarEventEntry();
         }      
      }
   
      // Handle new(to be added) and changed(to be updated) events
      if ( false == exists ) {
         // Create a recurring event
         // Set up the recurring details using an ical string (RFC 2445 http://www.ietf.org/rfc/rfc2445.txt)
         var recurrence = new google.gdata.Recurrence();
         var icalBreak = '\r\n'; //'\n'
         var recurrenceString = 'DTSTART;VALUE=DATE:' + date + icalBreak +
                                           'DTEND;VALUE=DATE:' + date + icalBreak +
                                           'RRULE:FREQ=YEARLY';
         recurrence.setValue(recurrenceString);
         
         // Create a Reminder object that will be attached to the When object
         var reminder = new google.gdata.Reminder();
         reminder.setDays( REMINDER_DAYS );                                
         reminder.setMethod( google.gdata.Reminder.METHOD_ALERT );

         // Insert contact title or fullname ???????
         entry.setTitle( contact.title.$t );
         entry.setContent( contact.title.$t );
         entry.setRecurrence( recurrence );
         entry.addReminder( reminder );
         
         batchid++;
         calService.insertEntry(eventURL, entry, callback, handleError, google.gdata.calendar.CalendarEventEntry);

         //TODO batchURL
      /*
         BatchUtils.setBatchId(entry, batchid.toString());
         if ( true == update ) { 
           BatchUtils.setBatchOperationType(entry, BatchOperationType.UPDATE);
         } else {
           BatchUtils.setBatchOperationType(entry, BatchOperationType.INSERT);     
         }
         batchRequest.getEntries().add(entry);
      */   
      }
   }
   
   // Get the batch link URL and send the batch request there.
/*
   if ( batchRequest.getEntries().isEmpty() ) {
      alert("No Batch Request");
   }else {
      alert("Send Calendar Batch Request");
      Link batchLink = eventFeed.getLink(Link.Rel.FEED_BATCH, Link.Type.ATOM);
      //CalendarEventFeed batchResponse = 
        calService.batch(new URL(batchLink.getHref()), batchRequest);
   }
*/
}
     

			function addEvent() {
				// Create a recurring event
				
				// Set up the recurring details using an ical string (RFC 2445 http://www.ietf.org/rfc/rfc2445.txt)
				var recurrence = new google.gdata.Recurrence();
				var icalBreak = '\r\n'; //'\n'
				var recurrenceString = 'DTSTART;VALUE=DATE:20090713' + icalBreak +
				    				   'DTEND;VALUE=DATE:20090713' + icalBreak +
				    				   'RRULE:FREQ=YEARLY';
				recurrence.setValue(recurrenceString);
				
				// Create a Reminder object that will be attached to the When object
				var reminder = new google.gdata.Reminder();
				reminder.setDays(REMINDER_DAYS);				
				reminder.setMethod(google.gdata.Reminder.METHOD_ALERT);
				
				// Create an instance of CalendarEventEntry representing the new event
				var entry = new google.gdata.calendar.CalendarEventEntry();
				entry.setTitle(google.gdata.Text.create('JS-Client: insert recurring event'));
				entry.setContent(google.gdata.Text.create('JS-Client: content'));
				entry.setRecurrence(recurrence);
				entry.addReminder(reminder);

				// This callback method that will be called after a successful insertion from insertEntry()
				var callback = function(result) {
				  alert ('entry added');
				}
				
				// Submit the request using the calendar service object
				//batchURL
				calService.insertEntry(eventURL, entry, callback, handleError, google.gdata.calendar.CalendarEventEntry);

			}     
            /**
             * This function is called if an error is encountered
             *  while retrieving a feed or adding an event.
             */
            function handleError(e){
                // Commented out because of:
				// getFeed causes:
				//   Invalid json format. 
				//     Unescaped json is a not supported format for attributes or text values.
				//   But getting is not interrupted!
				//alert(e.cause ? e.cause.statusText : e.message);
            };
            
			//TODO Why opens a file download dialog 3 times ???
			//local
			//<img src="http://127.0.0.1:8000/gCalBirthdays/test/gCalBirthdays.jpg" alt="gCalBirthdays Logo"/>
			//<img src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/test/gCalBirthdays.jpg" alt="gCalBirthdays Logo"/>
			
            //]]>
        </script>

    </head>
    <body>
		
    	<img src="gCalBirthdays.gif" alt="gCalBirthdays Logo"/>
        <p>
            <div class="indent">
                Welcome to gCalBirthdays, an app that transfer Your Google Contacts birthdays to Your Google Calendar.
            </div>
            <p>
                <div id="loginNotice" class="indent" style="color:#cc0000; font-weight:bold; display:none">
                    Because this is a third-party app that uses your Google account authentication, you'll need to grant access to it by clicking the "Login" button. 
                </div>
                <p>
                    <div class="indent">
                        <input id="auth_button" type="button" value="Authenticate" onclick="loginOrLogout()"/>
                    </div>
					<div id="htmlTable" class="indent" style="display:none">
                        <div id="htmlTableHeaderID" style="font-weight: bold; border-bottom:1px solid grey;">
                            Display Contacts:
                        </div>
                        <div id="htmlTableContentID">
                        </div>
                    </div>
			<div id="data"></div>
                    </body>
                </html>
