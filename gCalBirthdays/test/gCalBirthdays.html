<html>
<head>
<title>gCalBirthdays</title>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript">

/* Copyright (c) 2009 Frank Glaser
 * TODO
 */



// http://code.google.com/p/gdata-javascript-client/source/browse/trunk/samples/calendar/birthday_manager/birthday_manager.html
// http://gdata-javascript-client.googlecode.com/svn/trunk/samples/calendar/birthday_manager/birthday_manager.html
		
// http://code.google.com/p/gcalbirthdays/source/browse/trunk/gCalBirthdays/test/gCalBirthdays.html
// http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/test/gCalBirthdays.html

/* Copyright (c) 2007 Google Inc.
 *
 */

//load the Google data JS Client Library
//google.load('gdata', '1.x');
google.load("gdata", "1.x", {packages: ["contacts", "calendar"]});

var EVENT_FEED_URL = 'http://www.google.com/calendar/feeds/default/private/full';

var APP_NAME  = 'gCalBirthdays';

var CALENDAR_NAME    = 'Birthdays';  //"Geburtstage";
var CALENDAR_SUMMARY = 'This calendar contains the birthdays of Your Google Contacts.';
var CALENDAR_COLOR   = '#A32929';    // red "#A32929", blue "#2952A3" and green "#0D7813"

var CONTACTS_FEED_URL  = 'http://www.google.com/m8/feeds/contacts/default/full';
var CALENDAR_FEED_URL = 'http://www.google.com/calendar/feeds/default/owncalendars/full';

var DATE_FORMAT_CONTACTS = 'yyyy-MM-dd';
var DATE_FORMAT_CALENDAR = 'yyyyMMdd';
var DATE_FORMAT_YEAR 	 = 'yyyy';

var REMINDER_DAYS = 14;

//This variables are used for retrieving and adding contacts/events
var conService;
var calService;

/**
* This function checks if the user is logged in, 
* and changes the login button and displayed sections accordingly.
* It also initializes the calendarService variable
* and calls a function to fill in the form based on the URL.
*/
function init() {

 var token = google.accounts.user.checkLogin(EVENT_FEED_URL);

 //conService = new google.gdata.contacts.ContactsService(APP_NAME);
 calService = new google.gdata.calendar.CalendarService(APP_NAME);
 
 var authButton = document.getElementById('auth_button');

 if (google.accounts.user.checkLogin(EVENT_FEED_URL)) {
   //document.getElementById('displayContacts').style.display = 'block';
   authButton.value = 'Logout';
 } else {
   document.getElementById('loginNotice').style.display = 'block';
   authButton.value = 'Login';
   getContacts();
 }
};

//Tells the google JS lib to call the init function once loaded
google.setOnLoadCallback(init);

/**
* This function is triggered by the login/logout button.
* If the user is logged in to the app, it logs them out.
* If the user is logged out to the app, it logs them in.
*/
function loginOrLogout(){
 var token = google.accounts.user.checkLogin(EVENT_FEED_URL);
 if (token) {
   google.accounts.user.logout();
   init();
 } else {
   google.accounts.user.login(EVENT_FEED_URL);
 }
}

/**
 * Retrieves contacts from Google Contacts.
 */
function getContacts() {
  var conQuery = new google.gdata.contacts.ContactQuery(CONTACTS_FEED_URL);

  //conQuery.setSortOrder('ascending');
  
  conService.getEventsFeed(conQuery, handleContactsFeed, handleError);
}

/**
 * This function is called after the contacts query returns.
 * It parses through the entries.
 * It grabs the necessary information from the extended properties,
 * and displays each contact in a table row.
 * @param {google.gdata.ContactsFeed} resultsFeedRoot The events feed
 */

function handleContactsFeed(resultsFeedRoot) {
  var conList = document.getElementById('displayContacts');
  conList.innerHTML = '';

  conFeed = resultsFeedRoot.feed;
  contacts = conFeed.getEntries();
  var displayContactsTable = document.createElement('table');
  var displayContactsTbody = document.createElement('tbody');
  for (var i = 0; i < contacts.length; i++) {
    //contact.getName().getFullName().getValue()
	var conTitle = contacts[i].getTitle().getText();
        
    //if (eventTitle.match('Birthday Reminder')) {
    var conRow = document.createElement('tr');

    var name = conTitle;
 
    var nameCell = document.createElement('td');
    nameCell.appendChild(document.createTextNode(name));

    conRow.appendChild(nameCell);
      
    displayContactsTbody.appendChild(conRow);
  }
  
  displayContactsTable.appendChild(displayContactsTbody);
  displayContactsContent.appendChild(displayContactsTable);
}

/**
 * This function is called if an error is encountered
 *  while retrieving a feed or adding an event.
 */
function handleError(e) {
  alert(e.cause ? e.cause.statusText : e.message);
};




//]]>
</script>

</head>

<body>

<div class="indent">
Welcome to gCalBirthdays, an app that transfer Your Google Contacts birthdays to Your Google Calendar.
</div>
<p>

<div id="loginNotice" class="indent" style="color:#cc0000; font-weight:bold; display:none">
  Because this is a third-party app that uses your Google account authentication, you'll need to grant access to it by clicking the "Login" button. 
</div>

<div class="indent">
<input id="auth_button" type="button" value="Authenticate" onclick="loginOrLogout()"/>
</div>

<div id="addBirthday" class="indent" style="display:none">
	<div id="addEventHeader" style="font-weight: bold; border-bottom:1px solid grey;">Add Birthday:</div>
    <table>
      <tr>
        <td>Name:</td>
        <td><input id="name" type="text" style="width:100%"></td>
      </tr>
      <tr>
        <td>Birthdate:</td>
        <td><input id="birthdate" type="text" value="2007-08-16" style="width:100%"/></td>
      </tr>
    </table>
</div>

<div id="displayContacts" class="indent" style="display:none">
<div id="displayContactsHeader" style="font-weight: bold; border-bottom:1px solid grey;">Display Contacts:</div>
<div id="displayContactsContent"></div>
</div>

</body>

</html>
