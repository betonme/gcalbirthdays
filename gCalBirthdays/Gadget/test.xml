<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs
    title="gCalBirthdays"
    title_url="http://gcalbirthdays.googlecode.com"
    author="Frank Glaser"
    author_email="GlaserFrank@gmail.com"
    height="100"
    scrolling="true">
    <Require feature="dynamic-height"/>
    <Require feature="setprefs"/>
    <Optional feature="google.calendar-0.5"/>
    <Optional feature="google.calendar-0.5.read"/>
    <OAuth>
      <Service name="gCalBirthdays">
        <Access url="https://www.google.com/accounts/OAuthGetAccessToken" method="GET" />
        <Request url="https://www.google.com/accounts/OAuthGetRequestToken?scope=http://www.google.com/m8/feeds/%20http://www.google.com/calendar/feeds/" method="GET" />
        <Authorization url="https://www.google.com/accounts/OAuthAuthorizeToken?oauth_callback=http://oauth.gmodules.com/gadgets/oauthcallback" />
      </Service>
    </OAuth>
  </ModulePrefs>
  <UserPref name="PrefsReminderDays" default_value="14" datatype="hidden"/>
  <UserPref name="Prefs_Group" default_value="0" datatype="hidden"/>
  <UserPref name="Prefs_Calendar" default_value="0" datatype="hidden"/>
  <Content type="html">
    <![CDATA[

      <!--http://code.google.com/p/gdata-javascript-client/-->
      <!--V2.00-->
      <!--http://www.google.com/uds/modules/gdata/gdata.js-->
      <script type="text/javascript" src="http://www.google.com/jsapi"></script>
      <!--script type="text/javascript" src="http://www.google.com/jsapi?autoload=%7Bmodules%3A%5B%7Bname%3Agdata%2Cversion%3A1.x%2Cpackages%3A%5Bcontacts%2Ccalendar%5D%7D%5D%7D"></script-->

      <!--http://www.prototypejs.org/-->
      <!--V1.6.0.3-->
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.3/prototype.js"></script>
      <!--adjustheight workaround: http://code.google.com/p/opensocial-resources/issues/detail?id=104-->
      <script type="text/javascript">Array.prototype.toJSON = null;</script>

      <!--http://www.bram.us/projects/js_bramus/jsprogressbarhandler/-->
      <!--V0.3.3-->
      <!--http://www.bram.us/demo/projects/jsprogressbarhandler/js/bramus/jsProgressBarHandler.js-->
      <script type="text/javascript" src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/JS/jsProgressBarHandler.js"></script>

      <!--http://phpjs.org/packages/view/396/name:7d67fb58ff9ab58f4d0e4e55221b50e7/-->
      <!--V2.8.6-->
      <!--http://phpjs.org/packages/download/396/name:html_funcs.min.js-->
      <script type="text/javascript" src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/JS/html_funcs.min.js"></script>

      <!--shindig oauth popup handling code-->
      <!--SVN140-->
      <!--http://code.google.com/p/gdata-samples/source/browse/trunk/gadgets/popup.js-->
      <script type="text/javascript" src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/JS/popup.js"></script>

      <!--gCalBirthay Javascript functions for HTML and Gadget Version-->
      <!--V1.16-->
      <script type="text/javascript" src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/JS/gCalBirthdays.js"></script>

      <!--gCalBirthay Gadget specific Javascript functions-->
      <script type="text/javascript">

        //IE JScript 5.6 Compatibility
        // Constants
        var APP_VERSION = '2.097';
        var MAX_HEIGHT = 300;

        // The gadget containers request that we do NOT run any JS inline.
        // Instead, register a callback handler.
        gadgets.util.registerOnLoadHandler(initGadget);

        function initGadget() {
          // Load the Google data JS Client Library
          //google.load('gdata', '2.x');
          // Save overhead, only load the necessary service
          google.load("gdata", "2.x", {packages: ['contacts', 'calendar']});

          // Tells the google JS lib to call the init function once loaded
          google.setOnLoadCallback(setupGadget);
        }

        function setupGadget(){
          myService = new google.gdata.calendar.CalendarService(APP_NAME);
          myService.useOAuth(APP_NAME);

          setupService();
          useOAuth();

          $('version').innerHTML = /*APP_NAME + ' ' +*/ 'Version: ' + APP_VERSION;
          getPreferences();
          showOneSection('main');
        };

        function handleOAuth(oauthApprovalUrl){
          // Display "Sign in" link (response.oauthApprovalUrl contains the URL)
          printConsole('OAuthApprovalUrl: ' + oauthApprovalUrl);

          // Create the popup handler. The onOpen function is called when the user
          // opens the popup window. The onClose function is called when the popup
          // window is closed.
          var popup = shindig.oauth.popup({
            destination: oauthApprovalUrl,
            windowOptions: 'height=600,width=800,status=no,depent=yes',
            onOpen: function() { showOneSection('waiting'); },
            onClose: function() { showSettings(); }
          });

          // Use the popup handler to attach onclick handlers to UI elements.  The
          // createOpenerOnClick() function returns an onclick handler to open the
          // popup window.  The createApprovedOnClick function returns an onclick
          // handler that will close the popup window and attempt to fetch the user's
          // data again.
          var personalize = $('personalize');
          personalize.onclick = popup.createOpenerOnClick();
          var approvaldone = $('approvaldone');
          approvaldone.onclick = popup.createApprovedOnClick();
          showOneSection('approval');
        }

        function showSettings() {
          showOneSection('busyloader');
          //getPreferences();
          queryGroupsAndCalendars();
        }

        function onclickSave() {
          printConsole('Button Save');
          setPreferences();
          showOneSection('main');
        }

        function onclickCancel() {
          printConsole('Button Cancel');
          showOneSection('main');
        }

        function onclickSync() {
          printConsole('Button Manual Sync');
          startTransfer();
          queryContactsAndEvents();
        }

        function onclickStop(){
          printConsole('Button Stop');
          statemachine = states.canceled;
          printConsole('StateMachine: ' + 'canceled');
          endTransfer();
        }

        function onfinishedSync(){
          statemachine = states.finished;
          printConsole('StateMachine: ' + 'finished');
          printConsole('Finished!');
          endTransfer();
        }

        function startTransfer(){
          setPreferences();
          showOneSection('progress');
        }

        function endTransfer(){
          showOneSection('main');
        }

        function getPreferences() {
          var prefs = new gadgets.Prefs();
          setReminder(prefs.getInt("PrefsReminderDays"));
          var gro = prefs.getInt("Prefs_Group");
          selectSetSelectedIndex('groupselect', gro);
          selectSetSelectedIndex('calendarselect', prefs.getInt("Prefs_Calendar"));
        }

        function setPreferences() {
          var prefs =  new gadgets.Prefs();
          prefs.set("PrefsReminderDays", getReminder());

          var gro = selectGetSelectedIndex('groupselect');
          //prefs.set("Prefs_Group", selectGetSelectedIndex('groupselect'));
          prefs.set("Prefs_Group", gro);

          prefs.set("Prefs_Calendar", selectGetSelectedIndex('calendarselect'));
        }

        function showOneSection(toshow) {
          var sections = [ 'main', 'approval', 'waiting', 'busyloader', 'settings', 'progress' ];
          printConsole('Show section: ' + toshow);
          for (var i=0; i < sections.length; ++i) {
            var s = sections[i];
            var el = $(s);
            if (s === toshow) {
              if (s === 'settings') {
                getPreferences();
              }
              el.style.display = "block";
            } else {
              el.style.display = "none";
            }
          }
          adjustHeight();
        }

        /**
         * Adjust the height of the gadget
         */
        function adjustHeight() {
          var sections = $('sections');
          sections.removeAttribute('style');

          var height = nodeHeight($('gadget'));
          if ( MAX_HEIGHT < height) {
            height = MAX_HEIGHT;

            // Put a scrollbar back on the gadget.
            sections.style.height = height - nodeHeight($('logo'));
            sections.style.overflowY = 'scroll';
            sections.scrollTop = 0;
          }
          gadgets.window.adjustHeight(height);
        }
      </script>

      <style type="text/css">
        #settingslink {
          cursor: pointer;
          font-size: 11px;
          text-decoration: underline;
          color: blue;
          float: right;
          padding: 0 3px 0 3px;
        }

        #text {
          font-size: 11px;
          padding: 0 3px 0 3px;
        }

        div {
          font-size: 11px;
          padding: 0 3px 0 3px;
        }

        input {
          font-size: 11px;
        }

        select {
          font-size: 11px;
        }

        span {
          font-size: 11px;
        }
      </style>

      <div id="gadget">
        <img id='logo' src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/Gadget/gCalBirthdays.gif" alt="gCalBirthdays Logo"/>

        <div id="sections">
          <div id="main" style="display:none">
            <span id="version">Version</span>
            <span id="settingslink" onclick="showSettings()">Settings</span>
          </div>

          <div id="approval" style="display:none">
            <img src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/Images/popup.gif">
            <a href="#" id="personalize">Login</a>
          </div>

          <div id="waiting" style="display:none">
            Please click
            <a href="#" id="approvaldone">I've approved access</a>
            once you've approved access to your data.
          </div>

          <div id="busyloader" style="display:none">
            <img src="http://gcalbirthdays.googlecode.com/svn/trunk/gCalBirthdays/Images/busyLoader.gif" alt="BusyLoader Image">
          </div>

          <div id="settings" style="display:none">
            <table>
              <tr>
                <td id="text">Set Reminder:</td>
              </tr>
              <tr>
                <td id="text">
                  <input id="reminderinput" maxlength="2" style="width:30px" onkeypress="return isNumberKey(event)"/>
                  day(s)
                </td>
              </tr>
              <tr>
                <td id="text">Select Group(s):</td>
              </tr>
              <tr>
                <td>
                  <select id="groupselect" multiple="multiple" size="4"></select>
                </td>
              </tr>
              <tr>
                <td id="text">Select Calendar:</td>
              </tr>
              <tr>
                <td>
                  <select id="calendarselect" size="1" onchange="changeCalendar()"></select>
                </td>
              </tr>
            </table>
            <input id="sync" type="button" value="Manual Sync" onclick="onclickSync()">
            <input id="save" type="button" value="Save" onclick="onclickSave()">
            <input id="cancel" type="button" value="Cancel" onclick="onclickCancel()">
          </div>
          <div id="progress" style="display:none">
            <table>
              <tr>
                <td id="text">Load Contacts:</td>
              </tr>
              <tr>
                <td><span id="contactsprogressbar">0%</span></td>
              </tr>
              <tr>
                <td id="text">Load Events:</td>
              </tr>
              <tr>
                <td><span id="eventsprogressbar" class="progressBar">0%</span></td>
              </tr>
              <tr>
                <td id="text">Transfer Birthdays:</td>
              </tr>
              <tr>
                <td><span id="transferprogressbar" class="progressBar">0%</span></td>
              </tr>
            </table>
            <input id="stop" type="button" value="Cancel" onclick="onclickStop()">
          </div>
        </div>
      </div>

      <!--Google Analytics-->
      <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      </script>
      <script type="text/javascript">
        try {
          var pageTracker = _gat._getTracker("UA-9798979-1");
          pageTracker._trackPageview();
        }
        catch(err) {}
      </script>

    ]]>
  </Content>
</Module>
