<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
    <head>
        <meta name="generator" content="HTML Tidy, see www.w3.org">

        <title>gCalBirthdays</title>
			<script type="text/javascript" src="http://www.google.com/jsapi"></script>
			<script type="text/javascript">

            /*  Copyright (c) 2009 Frank Glaser
             *
             *  This program is free software: you can redistribute it and/or modify
             *  it under the terms of the GNU General Public License as published by
             *  the Free Software Foundation, either version 3 of the License, or
             *  (at your option) any later version.
             *
             *  This program is distributed in the hope that it will be useful,
             *  but WITHOUT ANY WARRANTY; without even the implied warranty of
             *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
             *  GNU General Public License for more details.
             *
             *  You should have received a copy of the GNU General Public License
             *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
             */

            /* Restrictions on GData JavaScript Client 1.10:
             * - The JavaScript client libraries don't yet support Contacts Data API Version 3.
             *     v2 has no birthday fields
             *     v2 has no support for structured name and postal address
             * - Batch operations are not supported by the JavaScript client library.
             */

            //load the Google data JS Client Library
            google.load('gdata', '1.x');
            // google.load("gdata", "1.x", {packages: ["contacts", "calendar"]});

            const APP_NAME = 'gCalBirthdays';
            const APP_VERSION = '0.10';

            const GOOGLE_FEED_AUTH = 'http://www.google.com/m8/feeds/ http://www.google.com/calendar/feeds/';

			const GROUP_FEED_URL = 'http://www.google.com/m8/feeds/groups/default/thin'; //full
            const CALENDAR_FEED_URL = 'http://www.google.com/calendar/feeds/default/owncalendars/full';

            const CONTACTS_FEED_URL_FULL = 'http://www.google.com/m8/feeds/contacts/default/full';
			const CONTACTS_FEED_URL_BASE = 'http://google.com/m8/feeds/groups/user%40gmail.com/base/';

			const CONTACTS_VERSION_NAME = 'v';
			const CONTACTS_VERSION_NUMBER = '3.0';

            const CALENDAR_NAME = 'Birthdays'; // "Geburtstage";
            const CALENDAR_SUMMARY = 'This calendar contains the birthdays of Your Google Contacts.';
            const CALENDAR_COLOR = '#A32929'; // red "#A32929", blue "#2952A3" and green "#0D7813"
		    const EVENT_SUMMARY_SUFFIX = '\r\n\r\nCreated by gCalBirthdays';

            const CALENDAR_HIDDEN = false;
            const CALENDAR_SELECTED = true;

            const DATE_FORMAT_CONTACTS = 'yyyy-MM-dd';
            const DATE_FORMAT_CALENDAR = 'yyyyMMdd';
            const DATE_FORMAT_YEAR = 'yyyy';

			const ALL_CONTACTS = 'All contacts';
			const NEW_CALENDAR = 'New calendar';

			const ICAL_BREAK = '\r\n'; // '\n'

            const REMINDER_DAYS = 14;

            const MAX_RESULT = 50;

            var contactService;
			var groupService;
            var calendarService;

            var contactList;
            var eventList;

            var batchURL;
            var eventURL;

            var token;


            /**
			 * This function checks if the user is logged in, and changes the
			 * login button and displayed sections accordingly. It also
			 * initializes the calendarService variable and calls a function to
			 * fill in the form based on the URL.
			 */
            function init(){
                var authButton = document.getElementById('auth_button');

				document.getElementById('version').innerHTML = APP_NAME + ' Version: ' + APP_VERSION;

                // ContactsService v3 GoogleService WorkAround for Contact Birthdays
      			contactService = new google.gdata.client.GoogleService('cp', APP_NAME);

                // ContactsService v3 GoogleService WorkAround for Contact System Groups
                groupService = new google.gdata.client.GoogleService('cp', APP_NAME);

				// CalendarService v2
                calendarService = new google.gdata.calendar.CalendarService(APP_NAME);

                token = google.accounts.user.checkLogin(GOOGLE_FEED_AUTH);
                if (token) {
                   // User is loged in
                   authButton.value = 'Logout';
				   document.getElementById('loginNotice').style.display = 'none';
				   document.getElementById('htmlTable').style.display = 'block';
                   main();
                }
               else {
                   // User is loged out
                   authButton.value = 'Login';
                   document.getElementById('loginNotice').style.display = 'block';
				   document.getElementById('settings_block').style.display = 'none';
				   document.getElementById('htmlTable').style.display = 'none';

                   var htmlTableHeader = document.getElementById('htmlTableHeaderID');
                   htmlTableHeader.innerHTML = '';
                   var htmlTableContent = document.getElementById('htmlTableContentID');
                  htmlTableContent.innerHTML = '';
                }
            };

            // Tells the google JS lib to call the init function once loaded
            google.setOnLoadCallback(init);

            /**
			 * This function is triggered by the login/logout button. If the
			 * user is logged in to the app, it logs them out. If the user is
			 * logged out to the app, it logs them in.
			 */
            function onClickAuthButton(){
                token = google.accounts.user.checkLogin(GOOGLE_FEED_AUTH);
                if (token) {
                    // User is loged in
                    google.accounts.user.logout();
                }
                else {
                    // User is loged out
                    token = google.accounts.user.login(GOOGLE_FEED_AUTH);
                }
                init();
            }

            function main(){
              queryGroups();
			  queryCalendars();
            }

            function queryGroups(){
				// Query for all the contacts entry with this contact group
			    var query = new google.gdata.contacts.ContactQuery(GROUP_FEED_URL);

			    // Use query parameter to set the google contacts version
				query.setParam(CONTACTS_VERSION_NAME, CONTACTS_VERSION_NUMBER);

				// Submit the request using the contacts service object
				groupService.getFeed(query, handleGroupsFeed, handleError);
			}

			function handleGroupsFeed(feedRoot){
			  // An array of contact group entries
			  groups = feedRoot.feed.entry;

			  // Clear options
			  clearOptions('group_select');

			  // Add 'All contacts' option
		  	  addOption('group_select', ALL_CONTACTS, '', true);

			  // Sort groups - replace 'System Group: '
			  var id=0;
			  for each (var group in groups) {
			    group.title.$t = group.title.$t.replace(/System Group/gi,id++);
			  }
			  groups.sort(compareEntries);
			  for each (var group in groups) {
			    group.title.$t = group.title.$t.replace(/^.: /gi,'');
			  }

			  // Iterate through the array of contact groups, and add them to drop down box
			  for each ( var group in groups ) {
				addOption('group_select', group.title.$t, group.id.$t);
			  }

			   showSettingsBlock();
			}

            function queryCalendars(){
				// Query for all calendars
			    var query = new google.gdata.client.Query(CALENDAR_FEED_URL);

				// Submit the request using the contacts service object
              	calendarService.getOwnCalendarsFeed(query, handleCalendarsFeed, handleError);
            }

            function handleCalendarsFeed(feedRoot){
				// An array of calendar entries
				calendars = feedRoot.feed.getEntries();

				// Clear options
				clearOptions('calendar_select');

			  	// Sort calendars
				calendars.sort(compareEntries);

				// Iterate through the array of calendars, and add them to drop down box
                for each ( var calendar in calendars ) {
				   addToCalendarSelect('calendar_select', calendar.getTitle().getText(), calendar.getId().getValue(), calendar.getTitle().getText().search(/(Birthday|Geburtstag)/i)+1 );
                }

				// Add 'New Calendar' option
				addToCalendarSelect('calendar_select', NEW_CALENDAR, '');

				showSettingsBlock();
            }

			function addToCalendarSelect(id, text, value, selected){
				if (true == selected) {
					if ('undefined' == typeof addToCalendarSelect.counter) {
						addToCalendarSelect.counter = 1;
					}
					else {
						selected = false;
					}
				}
				addOption(id, text, value, selected);
			}
			
			function selectOption(id, selId){
				var elSel = document.getElementById(id);
				elSel.selectedIndex = selId;
			}

			function clearOptions(id){
				document.getElementById(id).length = 0;
			}
			
			function insertOption(id, text, value, selected){
				var elSelId;
				  for (elSelId=0; elSelId<elSel.length; elSelId++) {
				  	var option = elSel.options[elSelId];
				    if (0 < compareStrings(option.text, text)){
				        break;
				    }
				    else if ( option.text == 'New calendar' ){
				        break;
				    }
				  }
			    addOption(id, text, value, selected, elSelId);
				elSel.selectedIndex = elSelId;
			}
			
			function addOption(id, text, value, selected, elSelId){
			  var elSel = document.getElementById(id);
			  var elOptNew = document.createElement('option');
			  elOptNew.text = text;
			  elOptNew.value = value;
			  if (true == selected){
			  	elOptNew.selected = true;
			  }
			  try {
			  	// standards compliant; doesn't work in IE
				var elOptOld = elSel.options[elSelId];
			    elSel.add(elOptNew, elOptOld);
			  }
			  catch(ex) {
			  	// IE only
			    elSel.add(elOptNew, elSelId);
			  }		  
			}

			function compareNumbers(a, b) {
				return a - b;
			}

			function compareStrings(a, b) {
			 	return (b < a) - (a < b);
			}

			function compareEntries(a, b) {
			 	return compareStrings(a.title.$t.toLowerCase(), b.title.$t.toLowerCase());
			}

			function showSettingsBlock(){
				// Show settings block on second call
				// Group and calendar boxes are filled
				if ('undefined' == typeof showSettingsBlock.counter) {
					showSettingsBlock.counter = 1;
				}
				else {
					document.getElementById('settings_block').style.display = 'block';
				}
			}

			function onSelectNewCalendar(calendarSelectedIndex){
				if(NEW_CALENDAR == document.getElementById('calendar_select').options[calendarSelectedIndex].text) {
					var calendarName = prompt("Calendar name:","Birthdays");
					if (calendarName!=null && calendarName!=""){
						//insertCalendar(calendarName);
						insertOption('calendar_select', calendarName, calendarName, true);
					}
				}
			}

            function insertCalendar(calendarName){
              // Create an instance of CalendarEntry, representing the new calendar
              var calendarEntry = new google.gdata.calendar.CalendarEntry();

              // Set the calendar title
              calendarEntry.setTitle(google.gdata.Text.create(calendarName));

              // Set the calendar summary
              calendarEntry.setSummary(google.gdata.Text.create(CALENDAR_SUMMARY));

              // Set the color that represent this calendar in the Google Calendar UI
              var color = new google.gdata.calendar.ColorProperty();
			  color.setValue(CALENDAR_COLOR);
              calendarEntry.setColor(color);

              // Set the calendar to be visible in the Google Calendar UI
              var hidden = new google.gdata.calendar.HiddenProperty();
			  hidden.setValue(CALENDAR_HIDDEN);
              calendarEntry.setHidden(hidden);

              // Set the calendar to be selected in the Google Calendar UI
              var selected = new google.gdata.calendar.SelectedProperty()
			  selected.setValue(CALENDAR_SELECTED);
              calendarEntry.setSelected(selected);

              // The callback method that will be called after a
				// successful insertion from insertEntry()
              var insertCalendarCallback = function(entryRoot){
				  // DEBUG: alert('Calendar created!');
				  //getCalendars( CALENDAR_FEED_URL );

				  //var calendarName = entryRoot.entry.getTitle().getText();
				  //setTimeout("selFromBox('calendar_select', calendarName)",1000);
				  //selFromBox('calendar_select', entryRoot.entry.getTitle().getText());

				  //TODO
				  //insertOptionBefore('calendar_select', entryRoot.entry.getTitle().getText(), entryRoot.entry.getId().getValue(), true );
              }

              // Submit the request using the calendar service object
              calendarService.insertEntry(CALENDAR_FEED_URL, calendarEntry, insertCalendarCallback, handleError, google.gdata.calendar.CalendarEntry);
            }

            function startTransfer(groupSelectedIndex, calendarSelectedIndex){
			  	var calendarId;

				calendarId = document.getElementById('calendar_select').options[calendarSelectedIndex].value;

			  	queryContacts( document.getElementById('group_select').options[groupSelectedIndex].value );

              	//queryContacts( document.getElementById('group_select').options[groupSelectedIndex].value ); // is executed after getContacts()

              	// getEvents( eventURL ); // is executed after getCalendars()
			}

            function queryContacts(groupId){
			    // Query for all the contacts entry with this contact group
			    var query = new google.gdata.contacts.ContactQuery(CONTACTS_FEED_URL_FULL);

			    // Use query parameter to set the google contacts version
				query.setParam(CONTACTS_VERSION_NAME, CONTACTS_VERSION_NUMBER);

				// Use query parameter to set the group ID
				if ('' != groupId) {
					query.setParam('group', groupId);
				}

              	// ContactsService v3 GoogleService WorkAround
              	contactService.getFeed(query, handleContactsFeed, handleError);
            }

            function getContacts(conURL){
              // ContactsService v3 GoogleService WorkAround
			  //if (-1 == conURL.search(/v=3\.0/i)) {
			  //  conURL = conURL + '?'+CONTACTS_VERSION_NAME+'='+CONTACTS_VERSION_NUMBER;
			  //}
              contactService.getFeed(conURL, handleContactsFeed, handleError);
            }

            function handleContactsFeed(feedRoot){
              contactList = new Array();

			  conFeed = feedRoot.feed;

              // ContactsService v3 GoogleService WorkAround
              contacts = conFeed.entry;

               for each ( var contact in contacts ) {
                  // Push only if contact has a title or fullname ???????
                  if ( contact.title.$t ) {
                     // Push only if contact has a birthday
                     //if ( contact.gContact$birthday ) {
                        contactList.push( contact );
                     //}
                  }
               }

              // ContactsService v3 GoogleService WorkAround
				 for each ( var link in conFeed.link ) {
					 if ('next' == link.rel) {
					 	return getContacts ( link.href );
					 }
				 }

              // Next step: Get calendars
              showContacts();
              //getCalendars( CALENDAR_FEED_URL );
            }

            function showContacts() {
               var htmlTableContent = document.getElementById('htmlTableContentID');
                var table = document.createElement('table');
                var tbody = document.createElement('tbody');

               for each ( var contact in contactList ) {
                  // ContactsService v3 GoogleService WorkAround
                  var conTitle = contact.title.$t;
                  if (contact.gd$name.gd$fullName) {
                     conTitle = conTitle + ' ' + contact.gd$name.gd$fullName.$t;
                  }
                  if (contact.gContact$birthday) {
                     conTitle = conTitle + ' ' + contact.gContact$birthday.when;
                  }

                    var row = document.createElement('tr');
                    var cell = document.createElement('td');
                    cell.appendChild(document.createTextNode("contact: "+conTitle));
                    row.appendChild(cell);
                    tbody.appendChild(row);
                }
                table.appendChild(tbody);
                htmlTableContent.appendChild(table);
            }

            function getEvents( eventURL ) {
               calendarService.getEventsFeed(eventURL, handleEventsFeed, handleError);
            }

           function handleEventsFeed(feedRoot) {
		   		eventList = new Array();

                eventFeed = feedRoot.feed;
                events = eventFeed.getEntries();

                 batchURL = eventFeed.getFeedBatchLink().href;

                for each ( var event in events ) {
                   eventList.push(event);
                }

                  if ( eventFeed.getNextLink() ) {
                      return getEvents( eventFeed.getNextLink().href );
                  }

                  // Next step: Check events
                   showEvents();
                   checkEvents();
              }

              function showEvents() {
                var htmlTableContent = document.getElementById('htmlTableContentID');
                var table = document.createElement('table');
                var tbody = document.createElement('tbody');

                   for each ( var event in eventList ) {
                    var eventTitle = event.getTitle().getText();;

                    var row = document.createElement('tr');
                    var cell = document.createElement('td');
                    cell.appendChild(document.createTextNode("event: "+eventTitle));
                    row.appendChild(cell);
                    tbody.appendChild(row);
                }
                table.appendChild(tbody);
                htmlTableContent.appendChild(table);
              }

               function checkEvents() {
                  var exists = false;
                   for each ( var contact in contactList ) {
                     exists = false;
                     var date = contact.gContact$birthday.when.replace(/-/g,'');
                     if ( 8 != date.length ) {
                        // To comply with Java long date
                        // (http://java.sun.com/j2se/1.3/docs/api/java/util/Date.html#Date(long))
                        date = '1970'+date;
                        //alert('1970: '+date);
                     }
                     for each ( var event in eventList ) {
                        exists = true;
                       // Check contact title or fullname ??????? indexOf??
		//Full Match to avoid errors on reuse calendars
                       if ( -1 != event.getTitle().getText().search( contact.title.$t ) ) {
                       // str.search(/W3Schools/i); // Case-insensitive Search
                           // Event found for given contact
                           // Check date
                           if ( -1 != event.getRecurrence().getValue().search( date ) ) {
                                // Date correct - nothing todo
                                //alert('date correct');
                           }
                           else {
                                // Date not correct - Update event
                                //alert('date update');
                                updateEvent( event, contact, date );
                           }
                        }
                     }
                     if ( false == exists ){
                       // Event not found for given contact - Add/Create event
                       //alert('date add');
                       insertEvent( contact, date );
                     }
                  }
                  // Next step: Finished
                  alert ('Finished!');
                }

              function insertEvent( contact, date ) {
                 var eventEntry = setEvent( new google.gdata.calendar.CalendarEventEntry(), contact, date );

                 // The callback method that will be called after a
					// successful insertion from insertEntry()
                 var insertEventCallback = function(result){
                     // DEBUG:
                     // alert('event added!');
                 }
                 calendarService.insertEntry(eventURL, eventEntry, insertEventCallback, handleError, google.gdata.calendar.CalendarEventEntry);
              }

              function updateEvent( eventEntry, contact, date ) {
                 var eventEntry = setEvent( eventEntry, contact, date );

                 // The callback method that will be called after a
					// successful update from updateEntry()
                 var updateEventCallback = function(result){
                     // DEBUG:
                     // alert('event updated!');
                 }
                 eventEntry.updateEntry( updateEventCallback, handleError )
              }

              function setEvent( eventEntry, contact, date ) {
                 // Create a recurring event

                 // Set the title of the event
                 // Insert contact title or fullname ???????
                 eventEntry.setTitle( google.gdata.Text.create(contact.title.$t) );

                 // Set the content of the event
                 eventEntry.setContent( google.gdata.Text.create(contact.title.$t + EVENT_SUMMARY_SUFFIX ) );

                 // Set up the recurring details using an ical string
                 // (RFC 2445 http://www.ietf.org/rfc/rfc2445.txt)
                 var recurrence = new google.gdata.Recurrence();
                 var recurrenceString = 'DTSTART;VALUE=DATE:' + date + ICAL_BREAK +
                                        'DTEND;VALUE=DATE:' + date + ICAL_BREAK +
                                        'RRULE:FREQ=YEARLY';
                 recurrence.setValue(recurrenceString);
                 eventEntry.setRecurrence( recurrence );

                 // Create a Reminder object that will be attached to the
                 var reminder = new google.gdata.Reminder();
                 reminder.setDays( REMINDER_DAYS );
                 reminder.setMethod( google.gdata.Reminder.METHOD_ALERT );
                 eventEntry.addReminder( reminder );

				 // Set Show me as to Available or Busy

                 return eventEntry;
              }

            /**
			 * This function is called if an error is encountered while
			 * retrieving a feed or adding an event.
			 */
            function handleError(e){
                // Commented out because of:
                 // getFeed causes:
                 // Invalid json format.
                 // Unescaped json is a not supported format for attributes
					// or text values.
                 // But getting is not interrupted!
                 //alert(e.cause ? e.cause.statusText : e.message);
            };

		</script>
    </head>

    <body>
        <img src="gCalBirthdays.gif" alt="gCalBirthdays Logo"> <br>

        <div id="version" class="indent">
            Version:
        </div>

        <div class="indent">
            Welcome to gCalBirthdays, an app that transfer Your
            Google Contacts birthdays to Your Google Calendar.
        </div>
        <br>

        <div id="loginNotice" class="indent" style="color:#cc0000; font-weight:bold; display:none">
            Because this is a third-party app that uses your Google
            account authentication, you'll need to grant access to
            it by clicking the "Login" button.
        </div>

        <div class="indent">
        	<form>
            	<input id="auth_button" type="button" value="Authenticate" onclick="onClickAuthButton()">
			</form>
        </div>

		<form id="settings_block" style="display:none">
			<table >
				<tr>
			        <div class="indent">
						<td>Select Group:</td>
						<td>
							<select id="group_select">
							</select>
						</td>
			        </div>
				</tr>
				<tr>
			        <div class="indent">
						<td>Select Calendar:</td>
						<td>
							<select id="calendar_select" onchange="onSelectNewCalendar(this.selectedIndex)">
							</select>
						</td>
			        </div>
				</tr>
			</table>
	        <div class="indent">
	            <input id="start_button" type="button" value="Go" onclick="startTransfer(this.form.group_select.selectedIndex, this.form.calendar_select.selectedIndex)">
	        </div>
		</form>

        <div id="htmlTable" class="indent" style="display:none">
            <div id="htmlTableHeaderID" style="font-weight: bold; border-bottom:1px solid grey;">
                Debug:
            </div>
            <div id="htmlTableContentID">
            </div>
        </div>

		<!--Google Analytics-->
		<script type="text/javascript">
		   var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
		   document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		</script>
		<script type="text/javascript">
		   try {
		      var pageTracker = _gat._getTracker("UA-9798979-3");
		      pageTracker._trackPageview();
		   }
		   catch(err) {}
		</script>

    </body>
</html>

